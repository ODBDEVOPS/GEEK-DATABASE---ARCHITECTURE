<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cin√©Grok Director - V2.0</title>
    <style>
        :root {
            --bg-dark: #0f1115;
            --panel-bg: #161b22;
            --accent: #00ff9d; /* N√©on Vert */
            --accent-dim: rgba(0, 255, 157, 0.15);
            --text-main: #e6edf3;
            --text-dim: #8b949e;
            --border: #30363d;
            --danger: #ff5555;
            --font-mono: 'SF Mono', 'Segoe UI Mono', 'Courier New', monospace;
            --font-ui: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; outline: none; }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: var(--font-ui);
            height: 100vh;
            width: 100vw;
            overflow: hidden; /* Viewport Fixe */
            display: flex;
            flex-direction: column;
        }

        /* HEADER & ACTIONS */
        header {
            height: 60px;
            background: var(--panel-bg);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
        }

        .brand {
            font-weight: 800;
            font-size: 1.2rem;
            letter-spacing: 1px;
            color: var(--accent);
            text-transform: uppercase;
        }

        .actions button {
            background: none;
            color: var(--accent);
            border: 1px solid var(--accent);
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 10px;
        }

        .actions button:hover { 
            background: var(--accent);
            color: var(--bg-dark);
        }

        /* MAIN LAYOUT */
        .workspace {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* SIDEBAR - CONFIGURATION */
        .sidebar {
            width: 350px;
            background: var(--panel-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
            z-index: 10;
        }

        h2 { font-size: 0.9rem; color: var(--text-dim); text-transform: uppercase; margin-top: 20px; margin-bottom: 10px; }
        h2:first-child { margin-top: 0; }

        label { display: block; font-size: 0.8rem; margin-bottom: 5px; color: var(--accent); }
        
        textarea, input, select {
            width: 100%;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            color: var(--text-main);
            border-radius: 6px;
            padding: 10px;
            font-family: var(--font-mono);
            font-size: 0.85rem;
            resize: vertical;
            transition: border-color 0.3s;
        }

        textarea:focus, input:focus { border-color: var(--accent); }

        .param-group { margin-bottom: 15px; }

        /* TIMELINE AREA */
        .timeline-container {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background-image: radial-gradient(#30363d 1px, transparent 1px);
            background-size: 20px 20px;
            position: relative;
        }

        .scene-list {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding-bottom: 100px;
        }

        /* SCENE CARD */
        .scene-card {
            background: rgba(22, 27, 34, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            position: relative;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            cursor: pointer; /* Indique la possibilit√© de Drag & Drop */
        }
        
        /* Drag & Drop Styles */
        .scene-card:hover {
            border-color: var(--accent);
            box-shadow: 0 0 15px var(--accent-dim);
            transform: scale(1.01);
        }
        .scene-card.dragging {
            opacity: 0.5;
            border: 2px dashed var(--accent);
            transform: scale(0.95);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            align-items: center;
            cursor: move; /* Indique la zone de Drag */
        }

        .scene-number {
            font-family: var(--font-mono);
            color: var(--accent);
            font-weight: bold;
            background: var(--accent-dim);
            padding: 4px 8px;
            border-radius: 4px;
        }

        .scene-controls {
            display: flex;
            gap: 5px;
        }

        .btn-icon {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dim);
            cursor: pointer;
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        
        .btn-icon:hover { color: var(--text-main); border-color: var(--text-main); }
        .btn-delete:hover { color: var(--danger); border-color: var(--danger); }
        .btn-random:hover { color: gold; border-color: gold; }

        .input-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        .input-camera-group {
            display: flex;
            gap: 5px;
            align-items: flex-end;
        }
        .input-camera-group select { flex: 1; }

        .final-prompt-preview {
            background: #0d1117;
            padding: 15px;
            border-radius: 6px;
            border-left: 3px solid var(--accent);
            font-family: var(--font-mono);
            font-size: 0.75rem;
            color: var(--text-dim);
            white-space: pre-wrap;
            position: relative;
            cursor: copy;
        }
        .final-prompt-preview:hover { color: var(--text-main); }

        /* FAB */
        .fab-add {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--accent);
            border: none;
            color: var(--bg-dark);
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 255, 157, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
            z-index: 20;
        }

        .fab-add:hover { transform: scale(1.1) rotate(90deg); box-shadow: 0 6px 20px rgba(0, 255, 157, 0.6); }

        /* Stats Bar (Footer) */
        .stats-bar {
            height: 30px;
            background: #0d1117;
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 20px;
            font-size: 0.8rem;
            color: var(--text-dim);
            font-family: var(--font-mono);
            user-select: none;
        }
        .stat-item { margin-right: 20px; }
        .stat-value { color: var(--accent); font-weight: bold; }

        #saveStatus {
            margin-left: auto;
            color: #4caf50;
            transition: opacity 0.5s;
            opacity: 0.5;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--accent);
            color: var(--bg-dark);
            padding: 10px 20px;
            border-radius: 30px;
            font-weight: bold;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 30;
        }
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
    </style>
</head>
<body>

    <header>
        <div class="brand">Cin√©Grok <span style="font-size:0.5em; opacity:0.7">Director V2.0</span></div>
        <div class="actions">
            <button onclick="document.getElementById('fileInput').click()">Importer JSON</button>
            <input type="file" id="fileInput" style="display:none;" accept=".json" onchange="app.importAll(event)">
            <button onclick="app.exportAll()">Exporter JSON</button>
        </div>
    </header>

    <div class="workspace">
        <div class="sidebar">
            <h2>Character / Master</h2>
            <div class="param-group">
                <label>Physique du Chanteur (Master Prompt)</label>
                <textarea id="masterPrompt" rows="6" placeholder="Ex: Cyberpunk male singer...">Young rebellious rockstar with messy black hair, piercing blue eyes, wearing a vintage leather jacket and silver rings.</textarea>
            </div>

            <h2>Param√®tres Techniques</h2>
            <div class="param-group">
                <label>Style Visuel</label>
                <textarea id="techStyle" rows="5">Cinematic music video, 8k resolution, photorealistic, dramatic lighting, slow motion, high contrast, Arri Alexa footage.</textarea>
            </div>
            
            <div class="param-group">
                <label>Mots-cl√©s de Coh√©rence</label>
                <input type="text" id="consistencyTags" value="consistent face, identical character">
            </div>

            <div style="margin-top:auto; font-size:0.7rem; color:var(--text-dim); text-align:center;">
                Application Front-End Natif (HTML/CSS/JS)
            </div>
        </div>

        <div class="timeline-container" id="timelineScroll">
            <div id="sceneList" class="scene-list">
                </div>
        </div>
    </div>

    <div class="stats-bar">
        <div class="stat-item">SC√àNES: <span id="totalScenes" class="stat-value">0</span></div>
        <div class="stat-item">DUR√âE ESTIM√âE (6s/clip): <span id="totalTime" class="stat-value">00:00</span></div>
        <div class="stat-item" id="saveStatus">Sauvegard√©</div>
    </div>

    <button class="fab-add" onclick="app.addScene()">+</button>
    
    <div id="toast" class="toast">Prompt Copi√© !</div>

    <script>
        /**
         * Cin√©Grok Director - V2.0
         * G√®re l'√©tat, le rendu, la persistance locale et le Drag & Drop.
         */
        class ClipBuilder {
            constructor() {
                this.scenes = [];
                this.dragSrcEl = null; 
                this.availableCams = [
                    "Statique", "Slow zoom in", "Zoom out", "Pan right", "Pan left", "Tracking shot", 
                    "Handheld shake", "Low angle", "High angle", "Drone Orbit", "Dutch Angle", "Rack Focus", 
                    "Extreme wide shot", "Reverse tracking"
                ];

                // DOM Elements
                this.masterPromptInput = document.getElementById('masterPrompt');
                this.techStyleInput = document.getElementById('techStyle');
                this.consistencyInput = document.getElementById('consistencyTags');
                this.sceneListContainer = document.getElementById('sceneList');
                this.elTotalScenes = document.getElementById('totalScenes');
                this.elTotalTime = document.getElementById('totalTime');
                this.elSaveStatus = document.getElementById('saveStatus');

                this.init();
            }

            // --- INITIALISATION & PERSISTENCE ---

            init() {
                this.loadFromStorage();
                this.initListeners();
                
                if (this.scenes.length === 0) {
                    this.addScene("Young star looking intensely into the camera.", "Slow zoom in", false);
                } else {
                    this.refreshUI();
                }
            }

            initListeners() {
                const inputs = [this.masterPromptInput, this.techStyleInput, this.consistencyInput];
                inputs.forEach(input => {
                    input.addEventListener('input', () => {
                        this.renderPreviews();
                        this.saveToStorage();
                    });
                });
            }

            saveToStorage() {
                const data = {
                    master: this.masterPromptInput.value,
                    tech: this.techStyleInput.value,
                    consistency: this.consistencyInput.value,
                    scenes: this.scenes
                };
                localStorage.setItem('cinegrok_data', JSON.stringify(data));
                
                this.elSaveStatus.style.opacity = '1';
                setTimeout(() => this.elSaveStatus.style.opacity = '0.5', 1000);
            }

            loadFromStorage() {
                const data = localStorage.getItem('cinegrok_data');
                if (data) {
                    try {
                        const parsed = JSON.parse(data);
                        this.masterPromptInput.value = parsed.master || this.masterPromptInput.defaultValue;
                        this.techStyleInput.value = parsed.tech || this.techStyleInput.defaultValue;
                        this.consistencyInput.value = parsed.consistency || this.consistencyInput.defaultValue;
                        this.scenes = parsed.scenes || [];
                    } catch (e) {
                        console.error("Failed to parse LocalStorage data:", e);
                        this.scenes = [];
                    }
                }
            }
            
            // --- LOGIQUE CORE ---

            addScene(action = "", camera = "", doSave = true) {
                const id = Date.now();
                const scene = { id, action, camera };
                this.scenes.push(scene);
                this.refreshUI(); 
                if (doSave) this.saveToStorage();
                
                // Scroll to the new scene
                document.getElementById(`card-${id}`).scrollIntoView({ behavior: 'smooth', block: 'end' });
            }

            deleteScene(id) {
                if(confirm("Supprimer la sc√®ne " + this.scenes.findIndex(s => s.id === id) + " ?")) {
                    this.scenes = this.scenes.filter(s => s.id !== id);
                    this.refreshUI();
                    this.saveToStorage();
                }
            }

            updateScene(id, field, value) {
                const scene = this.scenes.find(s => s.id === id);
                if (scene) {
                    scene[field] = value;
                    this.renderPreviews();
                    this.saveToStorage();
                }
            }

            // --- GENERATEUR DE PROMPT ---
            
            generateFullPrompt(sceneObj) {
                const master = this.masterPromptInput.value.trim();
                const style = this.techStyleInput.value.trim();
                const consistency = this.consistencyInput.value.trim();
                
                const cameraPart = (sceneObj.camera && sceneObj.camera !== "Statique") ? `Camera: ${sceneObj.camera}` : 'static shot';
                
                let parts = [
                    master,
                    `Action: ${sceneObj.action}`,
                    cameraPart,
                    consistency,
                    style
                ];
                // Join and clean up multiple commas
                return parts.filter(p => p.length > 0).join(", ").replace(/, ,/g, ',');
            }

            // --- RENDU UI & STATS ---

            refreshUI() {
                this.sceneListContainer.innerHTML = '';
                
                this.scenes.forEach((scene, index) => {
                    const el = this.createSceneElement(scene, index + 1);
                    this.sceneListContainer.appendChild(el);
                });

                this.updateStats();
            }
            
            updateStats() {
                this.elTotalScenes.innerText = this.scenes.length;
                
                const totalSeconds = this.scenes.length * 6; // 6s per clip
                const mins = Math.floor(totalSeconds / 60);
                const secs = totalSeconds % 60;
                this.elTotalTime.innerText = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }

            // --- RENDU D'√âL√âMENT SC√àNE ---

            createCameraOptions(currentCam) {
                let options = '';
                this.availableCams.forEach(cam => {
                    options += `<option value="${cam}" ${currentCam === cam ? 'selected' : ''}>${cam}</option>`;
                });
                return options;
            }

            createSceneElement(scene, index) {
                const div = document.createElement('div');
                div.className = 'scene-card';
                div.id = `card-${scene.id}`;
                div.draggable = true; 

                this.addDnDEvents(div, scene.id);

                div.innerHTML = `
                    <div class="card-header">
                        <span class="scene-number">SC√àNE ${index.toString().padStart(2, '0')}</span>
                        <div class="scene-controls">
                            <button class="btn-icon btn-random" onclick="app.randomCam(${scene.id})" title="Cam√©ra Al√©atoire">üé≤</button>
                            <button class="btn-icon" onclick="app.copyPrompt(${scene.id})">üìã Copier</button>
                            <button class="btn-icon btn-delete" onclick="app.deleteScene(${scene.id})">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="input-row">
                        <div>
                            <label>Action / Sc√©nario</label>
                            <input type="text" value="${scene.action}" 
                                oninput="app.updateScene(${scene.id}, 'action', this.value)" 
                                placeholder="D√©crire l'action...">
                        </div>
                        <div class="input-camera-group">
                            <select id="sel-${scene.id}" onchange="app.updateScene(${scene.id}, 'camera', this.value)">
                                ${this.createCameraOptions(scene.camera)}
                            </select>
                        </div>
                    </div>
                    <div class="final-prompt-preview" id="preview-${scene.id}" onclick="app.copyPrompt(${scene.id})">
                        ${this.generateFullPrompt(scene)}
                    </div>
                `;
                return div;
            }

            // --- LOGIQUE DRAG & DROP NATIVE (Innovation 2) ---
            addDnDEvents(el, id) {
                el.addEventListener('dragstart', (e) => {
                    this.dragSrcEl = el;
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', id);
                    el.classList.add('dragging');
                });

                el.addEventListener('dragend', (e) => { el.classList.remove('dragging'); });
                el.addEventListener('dragover', (e) => { if (e.preventDefault) e.preventDefault(); e.dataTransfer.dropEffect = 'move'; return false; });
                el.addEventListener('dragenter', (e) => { el.style.border = '1px solid var(--accent)'; });
                el.addEventListener('dragleave', (e) => { el.style.border = ''; });

                el.addEventListener('drop', (e) => {
                    e.stopPropagation();
                    el.style.border = '';
                    
                    const draggedId = parseInt(this.dragSrcEl.id.replace('card-', ''));
                    const targetId = id;

                    if (draggedId !== targetId) {
                        this.reorderScenes(draggedId, targetId);
                    }
                    return false;
                });
            }

            reorderScenes(draggedId, targetId) {
                const draggedIndex = this.scenes.findIndex(s => s.id === draggedId);
                const targetIndex = this.scenes.findIndex(s => s.id === targetId);

                const [movedItem] = this.scenes.splice(draggedIndex, 1);
                this.scenes.splice(targetIndex, 0, movedItem);

                this.refreshUI();
                this.saveToStorage();
            }

            // --- OUTILS & EXPORT/IMPORT (Innovation 4 & 5) ---

            randomCam(id) {
                const nonStaticCams = this.availableCams.filter(c => c !== "Statique");
                const random = nonStaticCams[Math.floor(Math.random() * nonStaticCams.length)];
                
                this.updateScene(id, 'camera', random);
                const sel = document.getElementById(`sel-${id}`);
                if(sel) sel.value = random;
            }

            copyPrompt(id) {
                const scene = this.scenes.find(s => s.id === id);
                if (scene) {
                    const text = this.generateFullPrompt(scene);
                    navigator.clipboard.writeText(text).then(() => {
                        const t = document.getElementById('toast');
                        t.innerText = "Prompt Copi√© !";
                        t.classList.add('show');
                        setTimeout(()=>t.classList.remove('show'), 2000);
                    });
                }
            }

            exportAll() {
                const data = {
                    master: this.masterPromptInput.value,
                    tech: this.techStyleInput.value,
                    consistency: this.consistencyInput.value,
                    scenes: this.scenes
                };
                const jsonStr = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonStr], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'cinegrok_project_' + Date.now() + '.json';
                a.click();
            }
            
            importAll(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        this.masterPromptInput.value = data.master || "";
                        this.techStyleInput.value = data.tech || "";
                        this.consistencyInput.value = data.consistency || "";
                        this.scenes = data.scenes || [];
                        
                        this.refreshUI();
                        this.saveToStorage();
                        
                        const t = document.getElementById('toast');
                        t.innerText = "Projet JSON Import√© !";
                        t.style.backgroundColor = 'gold';
                        t.style.color = 'black';
                        t.classList.add('show');
                        setTimeout(()=>t.classList.remove('show'), 2000);
                    } catch (error) {
                        alert("Erreur lors de l'importation du fichier JSON.");
                    }
                };
                reader.readAsText(file);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.app = new ClipBuilder();
        });
    </script>
</body>
</html>
